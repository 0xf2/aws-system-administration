{
   "AWSTemplateFormatVersion":"2010-09-09",
   "Description":"Mezzanine-powered blog with RDS, served with Nginx.",
   "Parameters":{
      "KeyName":{
         "Description":"Name of an existing EC2 KeyPair to enable SSH access",
         "Type":"String"
      },
      "WebAMI":{
         "Type":"String"
      },
      "CeleryAMI":{
         "Type":"String"
      },
      "KeyPair":{
         "Type":"String"
      },
      "DBUser":{
         "Type":"String"
      },
      "DBPassword":{
         "Type":"String",
         "NoEcho":"TRUE"
      }
   },
   "Resources":{
      "CacheCluster":{
         "Type":"AWS::ElastiCache::CacheCluster",
         "Properties":{
            "CacheNodeType":"cache.r3.large",
            "CacheSecurityGroupNames":[
               "CacheSecurityGroup"
            ],
            "Engine":"memcached",
            "NumCacheNodes":"1"
         }
      },
      "CacheSecurityGroup":{
         "Type":"AWS::ElastiCache::SecurityGroup",
         "Properties":{
            "Description":"Allow access from Web instances"
         }
      },
      "CacheSecurityGroupIngress":{
         "Type":"AWS::ElastiCache::SecurityGroupIngress",
         "Properties":{
            "CacheSecurityGroupName":{
               "Ref":"CacheSecurityGroup"
            },
            "EC2SecurityGroupName":{
               "Ref":"WebSecurityGroup"
            }
         }
      },
      "BlogDB":{
         "Type":"AWS::RDS::DBInstance",
         "Properties":{
            "DBSecurityGroups":[
               {
                  "Ref":"DBSecurityGroup"
               }
            ],
            "DBName":"myblog",
            "AllocatedStorage":5,
            "DBInstanceClass":"t2.micro",
            "Engine":"MySQL",
            "EngineVersion":"5.5",
            "MasterUsername":{
               "Ref":"DBUser"
            },
            "MasterUserPassword":{
               "Ref":"DBPassword"
            }
         },
         "DeletionPolicy":"Snapshot"
      },
      "DBSecurityGroup":{
         "Type":"AWS::EC2::SecurityGroup",
         "Properties":{
            "GroupDescription":"Allow inbound MySQL access from web instances",
            "SecurityGroupIngress":[
               {
                  "IpProtocol":"tcp",
                  "FromPort":"3306",
                  "ToPort":"3306",
                  "SourceSecurityGroupName":{
                     "Ref":"WebSecurityGroup"
                  }
               },
               {
                  "IpProtocol":"tcp",
                  "FromPort":"3306",
                  "ToPort":"3306",
                  "SourceSecurityGroupName":{
                     "Ref":"CelerySecurityGroup"
                  }
               }
            ]
}
         },
         "CeleryQueue":{
            "Type":"AWS::SQS::Queue"
         },
         "MyBlogRole":{
            "Type":"AWS::IAM::Role",
            "Properties":{
               "AssumeRolePolicyDocument":{
                  "Statement":[
                     {
                        "Effect":"Allow",
                        "Principal":{
                           "Service":[
                              "ec2.amazonaws.com"
                           ]
                        },
                        "Action":[
                           "sts:AssumeRole"
                        ]
                     }
                  ]
               },
               "Path":"/"
            }
         },
         "MyBlogRolePolicies":{
            "Type":"AWS::IAM::Policy",
            "Properties":{
               "PolicyName":"MyBlogRole",
               "PolicyDocument":{
                  "Statement":[
                     {
                        "Effect":"Allow",
                        "Action":[
                           "sqs:*"
                        ],
                        "Resource":{
                           "Ref":"CeleryQueue"
                        }
                     }
                  ]
               },
               "Roles":[
                  {
                     "Ref":"MyBlogRole"
                  }
               ]
            }
         },
         "MyBlogInstanceProfile":{
            "Type":"AWS::IAM::InstanceProfile",
            "Properties":{
               "Path":"/",
               "Roles":[
                  {
                     "Ref":"MyBlogRole"
                  }
               ]
            }
         },
         "CeleryInstance":{
            "Type":"AWS::EC2::Instance",
            "Properties":{
               "SecurityGroups":[
                  {
                     "Ref":"CelerySecurityGroup"
                  }
               ],
               "KeyName":"my-ssh-keypair",
               "ImageId":{
                  "Ref":"CeleryAMI"
               },
               "IamInstanceProfile":{
                  "Ref":"MyBlogInstanceProfile"
               },
               "UserData":{
                  "Fn::Base64":{
                     "Fn::Join":[
                        "",
                        [
                           "{\"role\": \"celery\",",
                           " \"db_endpoint\": \"",
                           {
                              "Fn::GetAtt":[
                                 "BlogDB",
                                 "Endpoint.Address"
                              ]
                           },
                           "\",",
                           " \"db_user\": \"",
                           {
                              "Ref":"DBUser"
                           },
                           "\",",
                           " \"db_password\": \"",
                           {
                              "Ref":"DBPassword"
                           },
                           "\",",
                           " \"cache_endpoint\": \"",
                           {
                              "Fn::GetAtt":[
                                 "CacheCluster",
                                 "ConfigurationEndpoint.Address"
                              ]
                           },
                           "\"}"
                        ]
                     ]
                  }
               }
            }
         },
         "CelerySecurityGroup":{
            "Type":"AWS::EC2::SecurityGroup",
            "Properties":{
               "GroupDescription":"Allow SSH from anywhere",
               "SecurityGroupIngress":[
                  {
                     "IpProtocol":"tcp",
                     "FromPort":"22",
                     "ToPort":"22",
                     "CidrIp":"0.0.0.0/0"
                  }
               ]
            }
         },
         "CelerySecurityGroupIngress":{
            "Type":"AWS::ElastiCache::SecurityGroupIngress",
            "Properties":{
               "CacheSecurityGroupName":{
                  "Ref":"CacheSecurityGroup"
               },
               "EC2SecurityGroupName":{
                  "Ref":"CelerySecurityGroup"
               }
            }
         },
         "WebInstance":{
            "Type":"AWS::EC2::Instance",
            "Properties":{
               "SecurityGroups":[
                  {
                     "Ref":"WebSecurityGroup"
                  }
               ],
               "KeyName":{
                  "Ref":"KeyPair" },
                  "ImageId":{
                     "Ref":"WebAMI"
                  },
                  "IamInstanceProfile":{
                     "Ref":"MyBlogInstanceProfile"
                  },
                  "UserData":{
                     "Fn::Base64":{
                        "Fn::Join":[
                           "",
                           [
                              "{\"db_endpoint\": \"",
                              {
                                 "Fn::GetAtt":[
                                    "BlogDB",
                                    "Endpoint.Address"
                                 ]
                              },
                              "\",",
                              " \"db_user\": \"",
                              {
                                 "Ref":"DBUser"
                              },
                              "\",",
                              " \"db_password\": \"",
                              {
                                 "Ref":"DBPassword"
                              },
                              "\",",
                              " \"cache_endpoint\": \"",
                              {
                                 "Fn::GetAtt":[
                                    "CacheCluster",
                                    "ConfigurationEndpoint.Address"
                                 ]
                              },
                              "\" }"
                           ]
                        ]
                     }
                  }
               }
            },
            "WebSecurityGroup":{
               "Type":"AWS::EC2::SecurityGroup",
               "Properties":{
                  "GroupDescription":"Allow SSH and HTTP from anywhere",
                  "SecurityGroupIngress":[
                     {
                        "IpProtocol":"tcp",
                        "FromPort":"22",
                        "ToPort":"22",
                        "CidrIp":"0.0.0.0/0"
                     },
                     {
                        "IpProtocol":"tcp",
                        "FromPort":"80",
                        "ToPort":"80",
                        "CidrIp":"0.0.0.0/0"
                     }
                  ]
               }
            }
         }
      }
