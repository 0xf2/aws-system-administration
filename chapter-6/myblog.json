{
   "AWSTemplateFormatVersion":"2010-09-09",
   "Description":"Mezzanine-powered blog with RDS, served with Nginx.",
   "Parameters":{
      "KeyName":{
         "Description":"Name of an existing EC2 KeyPair to enable SSH access to the instance",
         "Type":"String"
      },
      "WebAMI":{
         "Type":"String"
      },
      "CeleryAMI":{
         "Type":"String"
      },
      "KeyPair":{
         "Type":"String"
      },
      "DBUser":{
         "Type":"String"
      },
      "DBPassword":{
         "Type":"String",
         "NoEcho":"TRUE"
      }
   },
   "Resources":{
      "CacheCluster":{
         "Type":"AWS::ElastiCache::CacheCluster",
         "Properties":{
            "CacheNodeType":"cache.r3.large",
            "CacheSecurityGroupNames":[
               "CacheSecurityGroup"
            ],
            "Engine":"memcached",
            "NumCacheNodes":"1"
         }
      },
      "CacheSecurityGroup":{
         "Type":"AWS::ElastiCache::SecurityGroup",
         "Properties":{
            "Description":"Allow access from Web instances"
         }
      },
      "CacheSecurityGroupIngress":{
         "Type":"AWS::ElastiCache::SecurityGroupIngress",
         "Properties":{
            "CacheSecurityGroupName":{
               "Ref":"CacheSecurityGroup"
            },
            "EC2SecurityGroupName":{
               "Ref":"WebSecurityGroup"
            }
         }
      },
      "BlogDB":{
         "Type":"AWS::RDS::DBInstance",
         "Properties":{
            "DBSecurityGroups":[
               {
                  "Ref":"DBSecurityGroup"
               }
            ],
            "DBName":"myblog",
            "AllocatedStorage":5,
            "DBInstanceClass":"t2.micro",
            "Engine":"MySQL",
            "EngineVersion":"5.5",
            "MasterUsername":{
               "Ref":"DBUser"
            },
            "MasterUserPassword":{
               "Ref":"DBPassword"
            }
         },
         "DeletionPolicy":"Snapshot"
      },
      "DBSecurityGroup":{
         "Type":"AWS::EC2::SecurityGroup",
         "Properties":{
            "GroupDescription":"Allow inbound MySQL access from web instances",
            "SecurityGroupIngress":[
               {
                  "IpProtocol":"tcp",
                  "FromPort":"3306",
                  "ToPort":"3306",
                  "SourceSecurityGroupName":{
                     "Ref":"WebSecurityGroup"
                  }
               },
               {
                  "IpProtocol":"tcp",
                  "FromPort":"3306",
                  "ToPort":"3306",
                  "SourceSecurityGroupName":{
                     "Ref":"CelerySecurityGroup"
                  }
               }
            ]
         },
         "CeleryQueue":{
            "Type":"AWS::SQS::Queue"
         },
         "MyBlogRole":{
            "Type":"AWS::IAM::Role",
            "Properties":{
               "AssumeRolePolicyDocument":{
                  "Statement":[
                     {
                        "Effect":"Allow",
                        "Principal":{
                           "Service":[
                              "ec2.amazonaws.com"
                           ]
                        },
                        "Action":[
                           "sts:AssumeRole"
                        ]
                     }
                  ]
               },
               "Path":"/"
            }
         },
         "MyBlogRolePolicies":{
            "Type":"AWS::IAM::Policy",
            "Properties":{
               "PolicyName":"MyBlogRole",
               "PolicyDocument":{
                  "Statement":[
                     {
                        "Effect":"Allow",
                        "Action":[
                           "sqs:*"
                        ],
                        "Resource":{
                           "Ref":"CeleryQueue"
                        }
                     }
                  ]
               },
               "Roles":[
                  {
                     "Ref":"MyBlogRole"
                  }
               ]
            }
         },
         "MyBlogInstanceProfile":{
            "Type":"AWS::IAM::InstanceProfile",
            "Properties":{
               "Path":"/",
               "Roles":[
                  {
                     "Ref":"MyBlogRole"
                  }
               ]
            }
         },
         "CeleryLaunchConfig":{
            "Type":"AWS::AutoScaling::LaunchConfiguration",
            "Properties":{
               "ImageId":{
                  "Ref":"CeleryAMI"
               },
               "SecurityGroups":[
                  {
                     "Ref":"CelerySecurityGroup"
                  }
               ]
            }
         },
         "CeleryGroup":{
            "Type":"AWS::AutoScaling::AutoScalingGroup",
            "Properties":{
               "AvailabilityZones":{
                  "Fn::GetAZs":""
               },
               "LaunchConfigurationName":{
                  "Ref":"CeleryLaunchConfig"
               },
               "MinSize":"1",
               "MaxSize":"2",
               "DesiredCapacity":"1"
            }
         },
         "WebLaunchConfig":{
            "Type":"AWS::AutoScaling::LaunchConfiguration",
            "Properties":{
               "ImageId":{
                  "Ref":"WebAMI"
               },
               "SecurityGroups":[
                  {
                     "Ref":"WebSecurityGroup"
                  }
               ]
            }
         },
         "WebGroup":{
            "Type":"AWS::AutoScaling::AutoScalingGroup",
            "Properties":{
               "AvailabilityZones":{
                  "Fn::GetAZs":""
               },
               "LaunchConfigurationName":{
                  "Ref":"WebLaunchConfig"
               },
               "MinSize":"1",
               "MaxSize":"2",
               "DesiredCapacity":"1"
            }
         }
      }
   },
   "CeleryScaleUpPolicy":{
      "Type":"AWS::AutoScaling::ScalingPolicy",
      "Properties":{
         "AdjustmentType":"ChangeInCapacity",
         "AutoScalingGroupName":{
            "Ref":"CeleryGroup"
         },
         "Cooldown":"1",
         "ScalingAdjustment":"1"
      }
   },
   "CeleryScaleDownPolicy":{
      "Type":"AWS::AutoScaling::ScalingPolicy",
      "Properties":{
         "AdjustmentType":"ChangeInCapacity",
         "AutoScalingGroupName":{
            "Ref":"CeleryGroup"
         },
         "Cooldown":"1",
         "ScalingAdjustment":"-1"
      }
   },
   "CelerySQSAlarmHigh":{
      "Type":"AWS::CloudWatch::Alarm",
      "Properties":{
         "EvaluationPeriods":"1",
         "Statistic":"Sum",
         "Threshold":"100",
         "AlarmDescription":"Triggered when SQS queue length >100",
         "Period":"60",
         "AlarmActions":[
            {
               "Ref":"CeleryScaleUpPolicy"
            }
         ],
         "Namespace":"AWS/SQS",
         "Dimensions":[
            {
               "Name":"QueueName",
               "Value":{
                  "GetAtt":[
                     "CeleryQueue",
                     "QueueName"
                  ]
               }
            }
         ],
         "ComparisonOperator":"GreaterThanThreshold",
         "MetricName":"ApproximateNumberOfMessagesVisible"
      }
   },
   "CelerySQSAlarmLow":{
      "Type":"AWS::CloudWatch::Alarm",
      "Properties":{
         "EvaluationPeriods":"1",
         "Statistic":"Sum",
         "Threshold":"20",
         "AlarmDescription":"Triggered when SQS queue length <20",
         "Period":"60",
         "AlarmActions":[
            {
               "Ref":"CeleryScaleDownPolicy"
            }
         ],
         "Namespace":"AWS/SQS",
         "Dimensions":[
            {
               "Name":"QueueName",
               "Value":{
                  "GetAtt":[
                     "CeleryQueue",
                     "QueueName"
                  ]
               }
            }
         ],
         "ComparisonOperator":"LessThanThreshold",
         "MetricName":"ApproximateNumberOfMessagesVisible"
      }
   },
   "WebELB":{
      "Type":"AWS::ElasticLoadBalancing::LoadBalancer",
      "Properties":{
         "AvailabilityZones":{
            "Fn::GetAZs":""
         },
         "Listeners":[
            {
               "LoadBalancerPort":"80",
               "InstancePort":"80",
               "Protocol":"HTTP"
            }
         ],
         "HealthCheck":{
            "Target":{
               "Fn::Join":[
                  "",
                  [
                     "HTTP:80/"
                  ]
               ]
            },
            "HealthyThreshold":"3",
            "UnhealthyThreshold":"5",
            "Interval":"30",
            "Timeout":"5"
         }
      }
   },
   "WebGroup":{
      "Type":"AWS::AutoScaling::AutoScalingGroup",
      "Properties":{
         "AvailabilityZones":{
            "Fn::GetAZs":""
         },
         "LaunchConfigurationName":{
            "Ref":"WebLaunchConfig"
         },
         "MinSize":"1",
         "MaxSize":"2",
         "DesiredCapacity":"2",
         "LoadBalancerNames":[
            {
               "Ref":"WebELB"
            }
         ]
      }
   }
}